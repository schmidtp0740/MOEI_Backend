box:
  id: golang
  ports:
    - "8000"
  
dev:
  steps:
    - wercker/setup-go-workspace:
      package-dir: github.com/schmidtp0740/moei_backend
    - internal/watch:
      code: |
        go get
        go build -o app
        ./app
      ports: "8000"
      reload: true
    
build:
  steps:
    - wercker/setup-go-workspace:
      package-dir: github.com/schmidtp0740/moei_backend
    - wercker/golint
    - script:
      name: go build
      code: |
        go get
        CGO_ENABLED=0 go build -a -ldflags '-s' -installsuffix cgo -o app .
    # - script:
    #   name: go test
    #   code: |
    #     go test
    - script:
      name: copy artifacts to output folder
      code: |
        cp -r app kubernetes ${WERCKER_OUTPUT_DIR}
        ls -la ${WERCKER_OUTPUT_DIR}


deploy:
  box: google/golang
  steps:
    - script:
      name: debug
      code: |
        echo "current"
        pwd
        ls -la ./
        echo "wercker root"
        echo $WERCKER_ROOT
        ls -la $WERCKER_ROOT
        mkdir -p /go/src/app
        cp -r . /go/src/app
        ls -la /go/src/app
    - script:
      cwd: /go/src/app
    - internal/docker-scratch-push:
        repository: schmidtp0740/moei_backend
        registry: https://registry.hub.docker.com/v2
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        tag: ${WERCKER_GIT_BRANCH}-${WERCKER_GIT_COMMIT}
        cmd: ./app
        ports: "8000"
    - script:
        name: debug
        code: |
          echo $WERCKER_ROOT
          ls -l $WERCKER_ROOT
    - bash-template:
        cwd: $WERCKER_ROOT/kubernetes
    - script:
        name: Remove template files
        cwd: $WERCKER_ROOT/kubernetes
        code: |
          rm *.template.yaml
    - kubectl:
        cwd: $WERCKER_ROOT/kubernetes
        server: ${KUBE_ENDPOINT}
        token: ${KUBE_TOKEN}
        insecure-skip-tls-verify: true
        command: apply -f .
    - script:
        name: cleanup
        cwd: $WERCKER_ROOT/kubernetes
        code: rm -rf *.pem deployment.yaml